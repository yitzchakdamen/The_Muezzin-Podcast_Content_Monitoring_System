
services:

  kafka:
    image: apache/kafka:latest
    container_name: kafka-broker
    environment:
      KAFKA_NODE_ID: 1 
      KAFKA_PROCESS_ROLES: broker,controller 
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093 
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker:9092 #localhost:9092 
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER 
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka-broker:9093  #localhost:9092 
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1 
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1 
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0 
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true 
    ports:
      - "9092:9092"
      - "9093:9093"


  kafdrop:
    image: obsidiandynamics/kafdrop:latest
    container_name: kafdrop
    environment:
      KAFKA_BROKERCONNECT: kafka-broker:9092
    ports:
      - "9000:9000"
    depends_on:
      - kafka

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:9.1.3
    container_name: elasticsearch
    environment:
      discovery.type: single-node 
      xpack.security.enabled: false 
      ES_JAVA_OPTS: -Xms1g -Xmx1g 
    ports:
      - "9200:9200"

  kibana:
    image: docker.elastic.co/kibana/kibana:9.1.3
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200/
    depends_on:
      - elasticsearch

  mongodb:
    image: mongodb/mongodb-community-server:latest
    container_name: mongodb
    ports:
      - "27017:27017"

  storage_service:
    build: 
      context: .
      dockerfile: storage_service/Dockerfile
    image: storage_service-image
    container_name: storage_service-container
    environment:
      LOGGER_NAME: storage_service
      PODCAST_FILES_PATH: data/podcasts
      BOOTSTRAP_SERVERS: kafka-broker:9092
      KAFKA_TOPIC_FILE_METADATA: file-metadata
      KAFKA_GROUP_ID_FILE_METADATA: information_consumption_processing
      ELASTICSEARCH_HOST: http://elasticsearch:9200
      ELASTICSEARCH_INDEX: audio_files-metadata
      MONGO_CLIENT_STRING: mongodb://mongodb:27017
      MONGO_DB: podcast_files
      MONGO_COLLECTION: audio_files
      ELASTICSEARCH_MAPPING_PATH: config/elasticsearch_mapping.json
    depends_on: 
      - elasticsearch
      - kafka
      - mongodb

  processing_metadata_service:
    build: 
      context: .
      dockerfile: processing_metadata_service/Dockerfile
    image: processing_metadata_service-image
    container_name: processing_metadata_service-container
    environment:
      LOGGER_NAME: processing_metadata_service
      PODCAST_FILES_PATH: data/podcasts
      BOOTSTRAP_SERVERS: kafka-broker:9092
      KAFKA_TOPIC_FILE_METADATA: file-metadata
      KAFKA_GROUP_ID_FILE_METADATA: information_consumption_processing
      ELASTICSEARCH_HOST: http://elasticsearch:9200
      ELASTICSEARCH_INDEX: audio_files-metadata
      MONGO_CLIENT_STRING: mongodb://mongodb:27017
      MONGO_DB: podcast_files
      MONGO_COLLECTION: audio_files
      ELASTICSEARCH_MAPPING_PATH: config/elasticsearch_mapping.json
    depends_on: 
      - elasticsearch
      - kafka
      - mongodb


